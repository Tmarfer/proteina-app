<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prote√≠naMax - Seu Assistente Nutricional Completo</title>
    <style>
        /* === VARI√ÅVEIS DE TEMA === */
        :root[data-theme="light"] {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #d1fae5;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-2: #f1f5f9;
            --text: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --gradient-primary: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-secondary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        :root[data-theme="dark"] {
            --primary: #10b981;
            --primary-dark: #34d399;
            --primary-light: #064e3b;
            --secondary: #a78bfa;
            --accent: #fbbf24;
            --danger: #f87171;
            --success: #34d399;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-2: #334155;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.5);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.6);
            --gradient-primary: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-secondary: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            --gradient-accent: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        /* === LAYOUT PRINCIPAL === */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === HEADER === */
        .app-header {
            background: var(--gradient-primary);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path fill="rgba(255,255,255,0.05)" d="M0,0 Q300,40 600,20 T1200,40 L1200,120 L0,120 Z"/></svg>');
            background-size: cover;
            opacity: 0.5;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo h1 {
            color: white;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .app-logo p {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* === NAVEGA√á√ÉO COM ABAS === */
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: var(--surface);
            padding: 8px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-sec);
            font-weight: 600;
            font-size: 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--surface-2);
            color: var(--text);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* === SE√á√ïES DE CONTE√öDO === */
        .tab-content {
            display: none;
            animation: fadeInUp 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* === CARDS === */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        /* === GRID DE STATS === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--gradient-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            color: white;
            transition: all 0.3s ease;
        }

        .stat-card:nth-child(2) {
            background: var(--gradient-secondary);
        }

        .stat-card:nth-child(3) {
            background: var(--gradient-accent);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin: 8px 0;
        }

        .stat-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        /* === INPUTS E FORMS === */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* === BOT√ïES === */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-full {
            width: 100%;
        }

        /* === TABELA === */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: var(--surface-2);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            color: var(--text-sec);
            position: sticky;
            top: 0;
            cursor: pointer;
        }

        th:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--surface-2);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* === BADGES === */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-protein { background: #10b98120; color: #10b981; }
        .badge-carbs { background: #f59e0b20; color: #f59e0b; }
        .badge-fat { background: #ef444420; color: #ef4444; }
        .badge-carne { background: #dc262620; color: #dc2626; }
        .badge-frango { background: #eab30820; color: #eab308; }
        .badge-peixe { background: #3b82f620; color: #3b82f6; }
        .badge-laticinio { background: #06b6d420; color: #06b6d4; }
        .badge-vegetal { background: #22c55e20; color: #22c55e; }
        .badge-suplemento { background: #a78bfa20; color: #a78bfa; }
        .badge-outros { background: #10b98120; color: #10b981; }

        /* === BARRA DE PROGRESSO === */
        .progress-bar-container {
            background: var(--surface-2);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .progress-protein { background: var(--gradient-primary); }
        .progress-carbs { background: var(--gradient-accent); }
        .progress-fat { background: linear-gradient(135deg, #ef4444, #dc2626); }

        /* === GR√ÅFICO DE PIZZA (CSS PURO) === */
        .pie-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
            background: conic-gradient(
                var(--primary) 0deg,
                var(--primary) calc(var(--protein-percent) * 3.6deg),
                var(--accent) calc(var(--protein-percent) * 3.6deg),
                var(--accent) calc((var(--protein-percent) + var(--carbs-percent)) * 3.6deg),
                var(--danger) calc((var(--protein-percent) + var(--carbs-percent)) * 3.6deg),
                var(--danger) 360deg
            );
            box-shadow: var(--shadow-lg);
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* === COMPARADOR === */
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .compare-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .compare-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
        }

        .compare-card.winner {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--surface), var(--primary-light));
        }

        /* === RECEITAS === */
        .recipe-card {
            background: var(--surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .recipe-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .recipe-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
        }

        .recipe-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .recipe-body {
            padding: 20px;
        }

        .recipe-macros {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .recipe-macro {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--surface-2);
            border-radius: 8px;
        }

        /* === HIST√ìRICO === */
        .history-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: var(--surface-2);
            border-color: var(--primary);
        }

        /* === √çCONE FAVORITO === */
        .favorite-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .favorite-btn.active {
            color: #fbbf24;
        }

        /* === ANIMA√á√ïES === */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* === RESPONSIVIDADE === */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .app-header {
                padding: 16px;
            }

            .app-logo h1 {
                font-size: 20px;
            }

            .nav-tabs {
                overflow-x: scroll;
            }

            .nav-tab {
                font-size: 12px;
                padding: 10px 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-sec);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* === LOADING === */
        .loading-spinner {
            border: 3px solid var(--surface-2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === SMOOTH SCROLL === */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-logo">
                    <div>
                        <h1>üèÜ Prote√≠naMax</h1>
                        <p>Seu Assistente Nutricional Completo</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="theme-icon">üåô</span> Tema
                    </button>
                </div>
            </div>
        </header>

        <!-- NAVEGA√á√ÉO -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('calculator')">üßÆ Calculadora</button>
            <button class="nav-tab" onclick="switchTab('foods')">ü•ó Alimentos</button>
            <button class="nav-tab" onclick="switchTab('compare')">‚öñÔ∏è Comparar</button>
            <button class="nav-tab" onclick="switchTab('recipes')">üë®‚Äçüç≥ Receitas</button>
            <button class="nav-tab" onclick="switchTab('planner')">üìÖ Planejador</button>
            <button class="nav-tab" onclick="switchTab('history')">üìú Hist√≥rico</button>
        </nav>

        <!-- TAB: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Meta Di√°ria</div>
                    <div class="stat-value"><span id="dash-protein-goal">-</span>g</div>
                    <div class="stat-subtitle">Prote√≠na</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Calorias</div>
                    <div class="stat-value"><span id="dash-calories">-</span></div>
                    <div class="stat-subtitle">TDEE calculado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Custo M√©dio</div>
                    <div class="stat-value">R$ <span id="dash-cost">-</span></div>
                    <div class="stat-subtitle">Por grama de prote√≠na</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Distribui√ß√£o de Macros</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: center;">
                    <div>
                        <div class="pie-chart" id="macro-pie" style="--protein-percent: 30; --carbs-percent: 40; --fat-percent: 30;"></div>
                        <div class="pie-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--primary);"></div>
                                <span><strong id="macro-protein-value">0</strong>g Prote√≠na</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--accent);"></div>
                                <span><strong id="macro-carbs-value">0</strong>g Carboidratos</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--danger);"></div>
                                <span><strong id="macro-fat-value">0</strong>g Gorduras</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600;">Prote√≠nas</span>
                                <span><strong id="protein-percent">30</strong>%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill progress-protein" style="width: 30%"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600;">Carboidratos</span>
                                <span><strong id="carbs-percent">40</strong>%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill progress-carbs" style="width: 40%"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600;">Gorduras</span>
                                <span><strong id="fat-percent">30</strong>%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill progress-fat" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚≠ê Alimentos Favoritos</h2>
                </div>
                <div id="favorites-list"></div>
            </div>
        </div>

        <!-- TAB: CALCULADORA -->
        <div id="tab-calculator" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üßÆ Calculadora de Macros Completa</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‚öñÔ∏è Peso (kg)</label>
                        <input type="number" class="form-input" id="calc-weight" placeholder="75">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìè Altura (cm)</label>
                        <input type="number" class="form-input" id="calc-height" placeholder="175">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üéÇ Idade</label>
                        <input type="number" class="form-input" id="calc-age" placeholder="25">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‚öß Sexo</label>
                        <select class="form-select" id="calc-gender">
                            <option value="male">Masculino</option>
                            <option value="female">Feminino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üèÉ N√≠vel de Atividade</label>
                        <select class="form-select" id="calc-activity">
                            <option value="1.2">Sedent√°rio (pouco ou nenhum exerc√≠cio)</option>
                            <option value="1.375">Leve (1-3x por semana)</option>
                            <option value="1.55" selected>Moderado (3-5x por semana)</option>
                            <option value="1.725">Intenso (6-7x por semana)</option>
                            <option value="1.9">Muito Intenso (2x por dia)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üéØ Objetivo</label>
                        <select class="form-select" id="calc-goal">
                            <option value="cutting">Cutting (Perda de Gordura)</option>
                            <option value="maintenance">Manuten√ß√£o</option>
                            <option value="bulking">Bulking (Ganho de Massa)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" onclick="calculateMacros()">
                    üßÆ Calcular Macros Personalizados
                </button>

                <div id="macro-results" style="display: none; margin-top: 24px;">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">‚úÖ Seus Macros Personalizados</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">TMB</div>
                            <div class="stat-value"><span id="result-tmb">-</span></div>
                            <div class="stat-subtitle">Taxa Metab√≥lica Basal</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">TDEE</div>
                            <div class="stat-value"><span id="result-tdee">-</span></div>
                            <div class="stat-subtitle">Gasto Cal√≥rico Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Meta Cal√≥rica</div>
                            <div class="stat-value"><span id="result-calories">-</span></div>
                            <div class="stat-subtitle">Para seu objetivo</div>
                        </div>
                    </div>
                    <div class="card" style="background: var(--surface-2); margin-top: 16px;">
                        <h4 style="margin-bottom: 16px;">üìä Distribui√ß√£o Di√°ria de Macros</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div>
                                <p style="font-weight: 600; margin-bottom: 8px;">ü•© Prote√≠nas</p>
                                <p style="font-size: 24px; font-weight: 800; color: var(--primary);"><span id="result-protein">-</span>g</p>
                                <p style="font-size: 12px; color: var(--text-sec);"><span id="result-protein-cal">-</span> kcal</p>
                            </div>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 8px;">üçö Carboidratos</p>
                                <p style="font-size: 24px; font-weight: 800; color: var(--accent);"><span id="result-carbs">-</span>g</p>
                                <p style="font-size: 12px; color: var(--text-sec);"><span id="result-carbs-cal">-</span> kcal</p>
                            </div>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 8px;">ü•ë Gorduras</p>
                                <p style="font-size: 24px; font-weight: 800; color: var(--danger);"><span id="result-fat">-</span>g</p>
                                <p style="font-size: 12px; color: var(--text-sec);"><span id="result-fat-cal">-</span> kcal</p>
                            </div>
                        </div>
                    </div>

                    <!-- REFER√äNCIAS CIENT√çFICAS -->
                    <div class="card" style="background: var(--surface); margin-top: 20px; border: 2px solid var(--border);">
                        <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            üìö Refer√™ncias Cient√≠ficas
                        </h4>
                        <div style="font-size: 13px; line-height: 1.8; color: var(--text-sec);">
                            <p style="margin-bottom: 16px; color: var(--text);">
                                Os c√°lculos desta calculadora s√£o baseados em estudos cient√≠ficos validados e amplamente utilizados na comunidade de nutri√ß√£o esportiva:
                            </p>

                            <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--primary);">
                                <strong style="color: var(--primary);">1. F√≥rmula de Mifflin-St Jeor (TMB)</strong><br>
                                <span style="font-size: 12px;">
                                    Mifflin, M.D., St Jeor, S.T., Hill, L.A., et al. (1990). "A new predictive equation for resting energy expenditure in healthy individuals."
                                    <br><strong>American Journal of Clinical Nutrition, 51(2), 241-247.</strong>
                                    <br>üîó <a href="https://pubmed.ncbi.nlm.nih.gov/2305711/" target="_blank" style="color: var(--primary); text-decoration: none;">https://pubmed.ncbi.nlm.nih.gov/2305711/</a>
                                    <br><em style="font-size: 11px; opacity: 0.8;">Esta f√≥rmula √© considerada 5% mais precisa que a equa√ß√£o de Harris-Benedict para popula√ß√µes modernas.</em>
                                </span>
                            </div>

                            <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--secondary);">
                                <strong style="color: var(--secondary);">2. Fatores de Atividade F√≠sica (TDEE)</strong><br>
                                <span style="font-size: 12px;">
                                    Harris, J.A., Benedict, F.G. (1918). "A Biometric Study of Human Basal Metabolism."
                                    <br><strong>Proceedings of the National Academy of Sciences, 4(12), 370-373.</strong>
                                    <br>üîó <a href="https://www.pnas.org/doi/10.1073/pnas.4.12.370" target="_blank" style="color: var(--secondary); text-decoration: none;">https://www.pnas.org/doi/10.1073/pnas.4.12.370</a>
                                    <br><em style="font-size: 11px; opacity: 0.8;">Os multiplicadores de atividade (1.2 a 1.9) s√£o baseados neste estudo cl√°ssico, validado por d√©cadas de uso cl√≠nico.</em>
                                </span>
                            </div>

                            <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--success);">
                                <strong style="color: var(--success);">3. Recomenda√ß√µes de Prote√≠na para Hipertrofia</strong><br>
                                <span style="font-size: 12px;">
                                    J√§ger, R., Kerksick, C.M., Campbell, B.I., et al. (2017). "International Society of Sports Nutrition Position Stand: protein and exercise."
                                    <br><strong>Journal of the International Society of Sports Nutrition, 14, 20.</strong>
                                    <br>üîó <a href="https://jissn.biomedcentral.com/articles/10.1186/s12970-017-0177-8" target="_blank" style="color: var(--success); text-decoration: none;">https://jissn.biomedcentral.com/articles/10.1186/s12970-017-0177-8</a>
                                    <br><em style="font-size: 11px; opacity: 0.8;">Recomenda 1.4-2.0 g/kg/dia para atletas, com at√© 2.2 g/kg/dia para cutting. Nossa calculadora usa 2.0-2.2 g/kg conforme objetivo.</em>
                                </span>
                            </div>

                            <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--accent);">
                                <strong style="color: var(--accent);">4. Distribui√ß√£o de Macronutrientes</strong><br>
                                <span style="font-size: 12px;">
                                    Helms, E.R., Aragon, A.A., Fitschen, P.J. (2014). "Evidence-based recommendations for natural bodybuilding contest preparation: nutrition and supplementation."
                                    <br><strong>Journal of the International Society of Sports Nutrition, 11, 20.</strong>
                                    <br>üîó <a href="https://jissn.biomedcentral.com/articles/10.1186/1550-2783-11-20" target="_blank" style="color: var(--accent); text-decoration: none;">https://jissn.biomedcentral.com/articles/10.1186/1550-2783-11-20</a>
                                    <br><em style="font-size: 11px; opacity: 0.8;">Define diretrizes para distribui√ß√£o de carboidratos e gorduras baseadas no objetivo (cutting: 35% carbs, bulking: 45% carbs).</em>
                                </span>
                            </div>

                            <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; border-left: 3px solid var(--danger);">
                                <strong style="color: var(--danger);">5. Ingest√£o de Gorduras Essenciais</strong><br>
                                <span style="font-size: 12px;">
                                    Simopoulos, A.P. (2016). "An Increase in the Omega-6/Omega-3 Fatty Acid Ratio Increases the Risk for Obesity."
                                    <br><strong>Nutrients, 8(3), 128.</strong>
                                    <br>üîó <a href="https://www.mdpi.com/2072-6643/8/3/128" target="_blank" style="color: var(--danger); text-decoration: none;">https://www.mdpi.com/2072-6643/8/3/128</a>
                                    <br><em style="font-size: 11px; opacity: 0.8;">Recomenda 0.5-1.5 g/kg de gorduras (25-30% das calorias) para fun√ß√£o hormonal e sa√∫de √≥timas.</em>
                                </span>
                            </div>

                            <div style="margin-top: 16px; padding: 12px; background: var(--highlight); border-radius: 8px; border: 1px solid var(--primary);">
                                <strong style="color: var(--primary); font-size: 14px;">üìå Nota Importante:</strong><br>
                                <span style="font-size: 12px;">
                                    Estes c√°lculos fornecem estimativas baseadas em equa√ß√µes validadas cientificamente.
                                    Valores individuais podem variar devido a fatores como composi√ß√£o corporal, gen√©tica,
                                    metabolismo e condi√ß√µes de sa√∫de. Para um plano nutricional personalizado, consulte
                                    um nutricionista esportivo certificado.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ALIMENTOS -->
        <div id="tab-foods" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ü•ó Base de Alimentos</h2>
                </div>

                <input type="text" class="form-input" id="food-search" placeholder="üîç Buscar alimento..." onkeyup="filterFoods()" style="margin-bottom: 16px;">

                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('')">Todos</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('carne')">ü•© Carne</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('frango')">üçó Frango</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('peixe')">üêü Peixe</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('laticinio')">ü•õ Latic√≠nio</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('vegetal')">üå± Vegetal</button>
                    <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="filterByCategory('suplemento')">‚ö° Suplem.</button>
                </div>

                <div class="table-wrapper">
                    <table id="foods-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable('nome')">Alimento ‚Üï</th>
                                <th onclick="sortTable('proteina')">Prot. (g) ‚Üï</th>
                                <th onclick="sortTable('carbs')">Carb. (g) ‚Üï</th>
                                <th onclick="sortTable('gordura')">Gord. (g) ‚Üï</th>
                                <th onclick="sortTable('calorias')">Calorias ‚Üï</th>
                                <th onclick="sortTable('custo')">R$/100g ‚Üï</th>
                                <th>Fav</th>
                            </tr>
                        </thead>
                        <tbody id="foods-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: COMPARADOR -->
        <div id="tab-compare" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öñÔ∏è Comparador de Alimentos</h2>
                </div>

                <p style="color: var(--text-sec); margin-bottom: 20px;">Selecione at√© 3 alimentos para comparar lado a lado:</p>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Alimento 1</label>
                        <select class="form-select" id="compare-food-1">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alimento 2</label>
                        <select class="form-select" id="compare-food-2">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alimento 3</label>
                        <select class="form-select" id="compare-food-3">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" onclick="compareFoods()">
                    ‚öñÔ∏è Comparar Alimentos
                </button>

                <div id="compare-results" style="margin-top: 24px;"></div>
            </div>
        </div>

        <!-- TAB: RECEITAS -->
        <div id="tab-recipes" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë®‚Äçüç≥ Receitas Proteicas</h2>
                </div>
                <div id="recipes-list"></div>
            </div>
        </div>

        <!-- TAB: PLANEJADOR -->
        <div id="tab-planner" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÖ Planejador de Refei√ß√µes</h2>
                </div>

                <div style="background: var(--highlight); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--primary);">
                    <h4 style="margin-bottom: 8px; color: var(--primary);">üí° Como Funciona:</h4>
                    <p style="color: var(--text-sec); font-size: 13px; line-height: 1.6;">
                        1. Selecione <strong>UMA fonte proteica</strong> para cada refei√ß√£o<br>
                        2. O sistema calcula a quantidade ideal baseada nas suas metas<br>
                        3. <strong>Sugest√µes autom√°ticas</strong> de carboidratos e gorduras s√£o geradas<br>
                        4. As quantidades s√£o ajustadas para serem <strong>realistas</strong> (ex: m√°x 3 ovos, 2 scoops whey, etc.)
                    </p>
                </div>

                <div id="meal-planner-container"></div>

                <button class="btn btn-primary btn-full" onclick="calculateSmartMealPlan()">
                    üßÆ Gerar Plano Inteligente
                </button>

                <div id="plan-results" style="display: none; margin-top: 24px;">
                </div>
            </div>
        </div>

        <!-- TAB: HIST√ìRICO -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìú Hist√≥rico de Planos</h2>
                    <button class="btn btn-outline" onclick="clearHistory()">üóëÔ∏è Limpar</button>
                </div>
                <div id="history-list"></div>
            </div>

            <!-- Detalhes do plano selecionado -->
            <div id="history-details" style="display: none; margin-top: 24px;"></div>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ïES DE UNIDADES E LIMITES REALISTAS ===
        const foodUnits = {
            // Suplementos em scoops
            'Whey Protein': { unit: 'scoop', gramsPerUnit: 30, maxUnits: 2, displayName: 'scoop' },
            'Albumina': { unit: 'scoop', gramsPerUnit: 30, maxUnits: 2, displayName: 'scoop' },
            'Case√≠na': { unit: 'scoop', gramsPerUnit: 30, maxUnits: 2, displayName: 'scoop' },

            // Ovos em unidades
            'Ovo Inteiro Cozido': { unit: 'unidade', gramsPerUnit: 50, maxUnits: 3, displayName: 'unidade' },
            'Clara de Ovo': { unit: 'unidade', gramsPerUnit: 33, maxUnits: 6, displayName: 'clara' },
            'Ovo Mexido': { unit: 'unidade', gramsPerUnit: 50, maxUnits: 3, displayName: 'unidade' },

            // Cottage em colheres
            'Queijo Cottage': { unit: 'colher', gramsPerUnit: 25, maxUnits: 2, displayName: 'colher de sopa' },

            // Atum com limite
            'Atum Enlatado': { unit: 'gramas', gramsPerUnit: 1, maxUnits: 100, displayName: 'g' },

            // Pasta de amendoim em colheres
            'Pasta de Amendoim': { unit: 'colher', gramsPerUnit: 15, maxUnits: 2, displayName: 'colher de sopa' },
        };

        // === DADOS COMPLETOS ===
        const foodsDatabase = [
            // Carnes
            { id: 1, nome: 'Patinho Bovino', categoria: 'carne', proteina: 35, carbs: 0, gordura: 3, calorias: 171, custo: 4.5, porcao: '100g' },
            { id: 2, nome: 'Fil√© Mignon', categoria: 'carne', proteina: 33, carbs: 0, gordura: 8, calorias: 213, custo: 8.0, porcao: '100g' },
            { id: 3, nome: 'Contra-Fil√©', categoria: 'carne', proteina: 32, carbs: 0, gordura: 10, calorias: 234, custo: 6.0, porcao: '100g' },
            { id: 4, nome: 'Alcatra', categoria: 'carne', proteina: 33, carbs: 0, gordura: 6, calorias: 195, custo: 5.5, porcao: '100g' },
            { id: 5, nome: 'Picanha', categoria: 'carne', proteina: 31, carbs: 0, gordura: 12, calorias: 248, custo: 9.0, porcao: '100g' },

            // Frango
            { id: 6, nome: 'Peito de Frango Grelhado', categoria: 'frango', proteina: 32, carbs: 0, gordura: 3, calorias: 159, custo: 1.5, porcao: '100g' },
            { id: 7, nome: 'Coxa de Frango', categoria: 'frango', proteina: 27, carbs: 0, gordura: 8, calorias: 185, custo: 1.2, porcao: '100g' },
            { id: 8, nome: 'Sobrecoxa de Frango', categoria: 'frango', proteina: 26, carbs: 0, gordura: 10, calorias: 198, custo: 1.0, porcao: '100g' },
            { id: 9, nome: 'Frango Desfiado', categoria: 'frango', proteina: 30, carbs: 0, gordura: 4, calorias: 160, custo: 1.8, porcao: '100g' },

            // Peixes
            { id: 10, nome: 'Til√°pia', categoria: 'peixe', proteina: 26, carbs: 0, gordura: 3, calorias: 129, custo: 5.0, porcao: '100g' },
            { id: 11, nome: 'Atum Enlatado', categoria: 'peixe', proteina: 24, carbs: 0, gordura: 1, calorias: 105, custo: 6.5, porcao: '100g' },
            { id: 12, nome: 'Salm√£o', categoria: 'peixe', proteina: 25, carbs: 0, gordura: 13, calorias: 231, custo: 12.0, porcao: '100g' },
            { id: 13, nome: 'Sardinha', categoria: 'peixe', proteina: 22, carbs: 0, gordura: 11, calorias: 195, custo: 3.5, porcao: '100g' },
            { id: 14, nome: 'Merluza', categoria: 'peixe', proteina: 18, carbs: 0, gordura: 1, calorias: 79, custo: 4.0, porcao: '100g' },

            // Latic√≠nios
            { id: 15, nome: 'Queijo Cottage', categoria: 'laticinio', proteina: 12, carbs: 3, gordura: 4, calorias: 98, custo: 3.5, porcao: '100g' },
            { id: 16, nome: 'Iogurte Grego Natural', categoria: 'laticinio', proteina: 10, carbs: 4, gordura: 5, calorias: 97, custo: 4.0, porcao: '100g' },
            { id: 17, nome: 'Leite Desnatado', categoria: 'laticinio', proteina: 3.5, carbs: 5, gordura: 0.1, calorias: 35, custo: 0.4, porcao: '100ml' },
            { id: 18, nome: 'Queijo Minas Frescal', categoria: 'laticinio', proteina: 17, carbs: 3, gordura: 19, calorias: 250, custo: 3.0, porcao: '100g' },
            { id: 19, nome: 'Ricota', categoria: 'laticinio', proteina: 11, carbs: 3, gordura: 8, calorias: 138, custo: 2.5, porcao: '100g' },

            // Ovos
            { id: 20, nome: 'Ovo Inteiro Cozido', categoria: 'outros', proteina: 13, carbs: 1, gordura: 11, calorias: 155, custo: 0.6, porcao: '100g (2 ovos)' },
            { id: 21, nome: 'Clara de Ovo', categoria: 'outros', proteina: 11, carbs: 1, gordura: 0.2, calorias: 52, custo: 0.4, porcao: '100g (3 claras)' },
            { id: 22, nome: 'Ovo Mexido', categoria: 'outros', proteina: 12, carbs: 2, gordura: 12, calorias: 166, custo: 0.7, porcao: '100g' },

            // Vegetais Proteicos
            { id: 23, nome: 'Lentilha Cozida', categoria: 'vegetal', proteina: 9, carbs: 20, gordura: 0.4, calorias: 116, custo: 1.2, porcao: '100g' },
            { id: 24, nome: 'Gr√£o de Bico Cozido', categoria: 'vegetal', proteina: 9, carbs: 27, gordura: 3, calorias: 164, custo: 1.5, porcao: '100g' },
            { id: 25, nome: 'Feij√£o Preto Cozido', categoria: 'vegetal', proteina: 8, carbs: 23, gordura: 0.5, calorias: 132, custo: 0.8, porcao: '100g' },
            { id: 26, nome: 'Edamame', categoria: 'vegetal', proteina: 11, carbs: 8, gordura: 5, calorias: 122, custo: 3.0, porcao: '100g' },
            { id: 27, nome: 'Tofu Firme', categoria: 'vegetal', proteina: 8, carbs: 2, gordura: 4, calorias: 76, custo: 2.5, porcao: '100g' },

            // Suplementos
            { id: 28, nome: 'Whey Protein', categoria: 'suplemento', proteina: 24, carbs: 3, gordura: 1.5, calorias: 120, custo: 3.5, porcao: '30g (1 scoop)' },
            { id: 29, nome: 'Albumina', categoria: 'suplemento', proteina: 22, carbs: 2, gordura: 0, calorias: 96, custo: 2.0, porcao: '30g' },
            { id: 30, nome: 'Case√≠na', categoria: 'suplemento', proteina: 24, carbs: 3, gordura: 1, calorias: 117, custo: 4.0, porcao: '30g' },
            { id: 31, nome: 'Barra de Prote√≠na', categoria: 'suplemento', proteina: 20, carbs: 25, gordura: 8, calorias: 252, custo: 8.0, porcao: '60g (1 unid)' },
            { id: 32, nome: 'Pasta de Amendoim', categoria: 'outros', proteina: 25, carbs: 20, gordura: 50, calorias: 588, custo: 2.5, porcao: '100g' },
        ];

        // === BASE DE CARBOIDRATOS ===
        const carbsDatabase = [
            { id: 1, nome: 'Arroz Branco Cozido', carbs: 28, proteina: 2.7, gordura: 0.3, calorias: 130, porcao: '100g' },
            { id: 2, nome: 'Arroz Integral Cozido', carbs: 23, proteina: 2.6, gordura: 0.9, calorias: 112, porcao: '100g' },
            { id: 3, nome: 'Batata Doce Cozida', carbs: 20, proteina: 0.6, gordura: 0.1, calorias: 86, porcao: '100g' },
            { id: 4, nome: 'Batata Inglesa Cozida', carbs: 17, proteina: 2, gordura: 0.1, calorias: 77, porcao: '100g' },
            { id: 5, nome: 'Macarr√£o Integral Cozido', carbs: 26, proteina: 5, gordura: 0.9, calorias: 131, porcao: '100g' },
            { id: 6, nome: 'Aveia em Flocos', carbs: 66, proteina: 14, gordura: 7, calorias: 389, porcao: '100g' },
            { id: 7, nome: 'P√£o Integral', carbs: 49, proteina: 9, gordura: 3.4, calorias: 265, porcao: '100g' },
            { id: 8, nome: 'Tapioca Hidratada', carbs: 88, proteina: 0.2, gordura: 0.02, calorias: 358, porcao: '100g' },
            { id: 9, nome: 'Mandioca Cozida', carbs: 30, proteina: 0.6, gordura: 0.3, calorias: 125, porcao: '100g' },
            { id: 10, nome: 'Banana', carbs: 23, proteina: 1.1, gordura: 0.3, calorias: 89, porcao: '100g' },
            { id: 11, nome: 'Ma√ß√£', carbs: 14, proteina: 0.3, gordura: 0.2, calorias: 52, porcao: '100g' },
            { id: 12, nome: 'Granola', carbs: 65, proteina: 10, gordura: 15, calorias: 450, porcao: '100g' },
        ];

        // === BASE DE GORDURAS SAUD√ÅVEIS ===
        const fatsDatabase = [
            { id: 1, nome: 'Azeite Extra Virgem', gordura: 100, carbs: 0, proteina: 0, calorias: 884, porcao: '100ml (6.7 col)' },
            { id: 2, nome: 'Abacate', gordura: 15, carbs: 9, proteina: 2, calorias: 160, porcao: '100g' },
            { id: 3, nome: 'Castanha do Par√°', gordura: 67, carbs: 12, proteina: 14, calorias: 656, porcao: '100g (15 unid)' },
            { id: 4, nome: 'Amendoim Torrado', gordura: 49, carbs: 16, proteina: 26, calorias: 567, porcao: '100g' },
            { id: 5, nome: 'Am√™ndoas', gordura: 50, carbs: 22, proteina: 21, calorias: 579, porcao: '100g (70 unid)' },
            { id: 6, nome: 'Nozes', gordura: 65, carbs: 14, proteina: 15, calorias: 654, porcao: '100g (25 unid)' },
            { id: 7, nome: 'Chia', gordura: 31, carbs: 42, proteina: 17, calorias: 486, porcao: '100g' },
            { id: 8, nome: 'Linha√ßa', gordura: 42, carbs: 29, proteina: 18, calorias: 534, porcao: '100g' },
            { id: 9, nome: 'Coco Ralado', gordura: 65, carbs: 24, proteina: 6.9, calorias: 660, porcao: '100g' },
            { id: 10, nome: 'Manteiga de Amendoim Natural', gordura: 50, carbs: 20, proteina: 25, calorias: 588, porcao: '100g' },
        ];

        // === SUGEST√ïES DE COMBINA√á√ïES POR REFEI√á√ÉO ===
        const mealSuggestions = {
            cafe: {
                carbs: ['Aveia em Flocos', 'P√£o Integral', 'Tapioca Hidratada', 'Banana', 'Granola'],
                fats: ['Manteiga de Amendoim Natural', 'Abacate', 'Castanha do Par√°', 'Am√™ndoas', 'Chia']
            },
            lancheManha: {
                carbs: ['Banana', 'Ma√ß√£', 'Aveia em Flocos', 'Granola'],
                fats: ['Castanha do Par√°', 'Am√™ndoas', 'Nozes', 'Manteiga de Amendoim Natural']
            },
            almoco: {
                carbs: ['Arroz Integral Cozido', 'Batata Doce Cozida', 'Batata Inglesa Cozida', 'Macarr√£o Integral Cozido'],
                fats: ['Azeite Extra Virgem', 'Abacate']
            },
            lancheTarde: {
                carbs: ['Banana', 'Ma√ß√£', 'Batata Doce Cozida', 'Tapioca Hidratada'],
                fats: ['Amendoim Torrado', 'Castanha do Par√°', 'Manteiga de Amendoim Natural']
            },
            jantar: {
                carbs: ['Arroz Integral Cozido', 'Batata Doce Cozida', 'Mandioca Cozida', 'Macarr√£o Integral Cozido'],
                fats: ['Azeite Extra Virgem', 'Abacate', 'Am√™ndoas']
            },
            ceia: {
                carbs: ['Aveia em Flocos', 'Banana'],
                fats: ['Manteiga de Amendoim Natural', 'Am√™ndoas', 'Nozes']
            }
        };

        const recipesDatabase = [
            {
                id: 1,
                nome: 'Omelete Proteica',
                proteina: 35,
                carbs: 5,
                gordura: 18,
                calorias: 320,
                tempo: '10 min',
                ingredientes: ['4 claras de ovo', '2 ovos inteiros', '50g queijo cottage', 'Temperos a gosto'],
                preparo: '1. Bata os ovos com as claras. 2. Adicione o cottage. 3. Frite em frigideira antiaderente. 4. Tempere e sirva.'
            },
            {
                id: 2,
                nome: 'Frango com Batata Doce',
                proteina: 45,
                carbs: 35,
                gordura: 8,
                calorias: 400,
                tempo: '30 min',
                ingredientes: ['200g peito de frango', '150g batata doce', 'Azeite', 'Temperos'],
                preparo: '1. Tempere e grelhe o frango. 2. Asse a batata doce. 3. Sirva com legumes.'
            },
            {
                id: 3,
                nome: 'Panqueca Proteica',
                proteina: 30,
                carbs: 25,
                gordura: 10,
                calorias: 310,
                tempo: '15 min',
                ingredientes: ['2 ovos', '30g whey protein', '50g aveia', '100ml leite desnatado'],
                preparo: '1. Bata todos ingredientes no liquidificador. 2. Frite em frigideira antiaderente. 3. Sirva com frutas.'
            },
            {
                id: 4,
                nome: 'Iogurte Proteico com Frutas',
                proteina: 25,
                carbs: 30,
                gordura: 8,
                calorias: 290,
                tempo: '5 min',
                ingredientes: ['200g iogurte grego', '1 scoop whey', '100g frutas vermelhas', '20g granola'],
                preparo: '1. Misture o whey ao iogurte. 2. Adicione as frutas. 3. Finalize com granola.'
            },
            {
                id: 5,
                nome: 'Wrap de Frango',
                proteina: 40,
                carbs: 45,
                gordura: 12,
                calorias: 452,
                tempo: '20 min',
                ingredientes: ['150g frango desfiado', '1 tortilha integral', 'Alface, tomate', '30g queijo cottage'],
                preparo: '1. Aque√ßa o frango. 2. Monte o wrap com todos ingredientes. 3. Enrole e sirva.'
            },
            {
                id: 6,
                nome: 'Smoothie Proteico',
                proteina: 35,
                carbs: 40,
                gordura: 6,
                calorias: 362,
                tempo: '5 min',
                ingredientes: ['1 scoop whey', '1 banana', '200ml leite desnatado', '1 col pasta amendoim', 'Gelo'],
                preparo: '1. Bata todos ingredientes no liquidificador. 2. Sirva gelado.'
            },
            {
                id: 7,
                nome: 'Salada de Atum',
                proteina: 32,
                carbs: 20,
                gordura: 10,
                calorias: 298,
                tempo: '10 min',
                ingredientes: ['1 lata atum', 'Mix de folhas', 'Tomate cereja', '50g gr√£o de bico', 'Azeite e lim√£o'],
                preparo: '1. Misture todos ingredientes. 2. Tempere com azeite e lim√£o.'
            },
            {
                id: 8,
                nome: 'Omelete no Pote',
                proteina: 28,
                carbs: 8,
                gordura: 15,
                calorias: 282,
                tempo: '3 min',
                ingredientes: ['3 ovos', '30g queijo', 'Tomate', 'Temperos'],
                preparo: '1. Bata os ovos em um pote. 2. Adicione queijo e tomate. 3. Micro-ondas por 2-3 minutos.'
            },
            {
                id: 9,
                nome: 'Bowl Proteico',
                proteina: 38,
                carbs: 50,
                gordura: 14,
                calorias: 478,
                tempo: '25 min',
                ingredientes: ['150g frango grelhado', '100g arroz integral', '50g feij√£o', 'Legumes grelhados'],
                preparo: '1. Cozinhe o arroz e feij√£o. 2. Grelhe o frango. 3. Monte o bowl com legumes.'
            },
            {
                id: 10,
                nome: 'Tapioca Proteica',
                proteina: 30,
                carbs: 35,
                gordura: 8,
                calorias: 332,
                tempo: '10 min',
                ingredientes: ['50g tapioca', '2 ovos', '50g queijo cottage', 'Peito de peru'],
                preparo: '1. Hidrate a tapioca. 2. Fa√ßa a tapioca na frigideira. 3. Recheie com ovo mexido, cottage e peru.'
            }
        ];

        // === ESTADO DA APLICA√á√ÉO ===
        let currentTheme = 'dark';
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        let currentSortField = 'nome';
        let currentSortOrder = 'asc';
        let currentCategory = '';
        let userMacros = null;

        // === INICIALIZA√á√ÉO ===
        document.addEventListener('DOMContentLoaded', function() {
            renderFoodsTable();
            renderFavorites();
            renderRecipes();
            renderHistory();
            populateCompareSelects();
            initMealPlanner();
            updateDashboard();
        });

        // === FUN√á√ïES DE NAVEGA√á√ÉO ===
        function switchTab(tabName) {
            // Remover active de todas as abas e conte√∫dos
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Ativar aba clicada
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-icon').textContent = currentTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // === CALCULADORA DE MACROS ===
        function calculateMacros() {
            const weight = parseFloat(document.getElementById('calc-weight').value);
            const height = parseFloat(document.getElementById('calc-height').value);
            const age = parseFloat(document.getElementById('calc-age').value);
            const gender = document.getElementById('calc-gender').value;
            const activity = parseFloat(document.getElementById('calc-activity').value);
            const goal = document.getElementById('calc-goal').value;

            if (!weight || !height || !age) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            // C√°lculo TMB (Mifflin-St Jeor)
            let tmb;
            if (gender === 'male') {
                tmb = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                tmb = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            // C√°lculo TDEE
            const tdee = tmb * activity;

            // Ajuste cal√≥rico baseado no objetivo
            let targetCalories;
            let proteinMultiplier;
            let carbsPercent;
            let fatPercent;

            switch(goal) {
                case 'cutting':
                    targetCalories = tdee - 500;
                    proteinMultiplier = 2.2;
                    carbsPercent = 35;
                    fatPercent = 25;
                    break;
                case 'bulking':
                    targetCalories = tdee + 300;
                    proteinMultiplier = 2.0;
                    carbsPercent = 45;
                    fatPercent = 25;
                    break;
                default: // maintenance
                    targetCalories = tdee;
                    proteinMultiplier = 2.0;
                    carbsPercent = 40;
                    fatPercent = 30;
            }

            // C√°lculo de macros
            const protein = weight * proteinMultiplier;
            const proteinCal = protein * 4;

            const fat = (targetCalories * (fatPercent / 100)) / 9;
            const fatCal = fat * 9;

            const carbs = (targetCalories - proteinCal - fatCal) / 4;
            const carbsCal = carbs * 4;

            // Salvar macros do usu√°rio
            userMacros = {
                tmb: Math.round(tmb),
                tdee: Math.round(tdee),
                calories: Math.round(targetCalories),
                protein: Math.round(protein),
                carbs: Math.round(carbs),
                fat: Math.round(fat),
                weight: weight
            };

            // Exibir resultados
            document.getElementById('result-tmb').textContent = Math.round(tmb) + ' kcal';
            document.getElementById('result-tdee').textContent = Math.round(tdee) + ' kcal';
            document.getElementById('result-calories').textContent = Math.round(targetCalories) + ' kcal';

            document.getElementById('result-protein').textContent = Math.round(protein);
            document.getElementById('result-protein-cal').textContent = Math.round(proteinCal);

            document.getElementById('result-carbs').textContent = Math.round(carbs);
            document.getElementById('result-carbs-cal').textContent = Math.round(carbsCal);

            document.getElementById('result-fat').textContent = Math.round(fat);
            document.getElementById('result-fat-cal').textContent = Math.round(fatCal);

            document.getElementById('macro-results').style.display = 'block';

            // Atualizar dashboard
            updateDashboard();

            // Rolar para resultados
            document.getElementById('macro-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // === ATUALIZAR DASHBOARD ===
        function updateDashboard() {
            if (userMacros) {
                document.getElementById('dash-protein-goal').textContent = userMacros.protein;
                document.getElementById('dash-calories').textContent = userMacros.calories;

                // Calcular custo m√©dio
                const avgCost = (foodsDatabase.reduce((sum, food) => sum + (food.custo / food.proteina), 0) / foodsDatabase.length).toFixed(3);
                document.getElementById('dash-cost').textContent = avgCost;

                // Atualizar gr√°fico de pizza e barras
                const totalMacros = userMacros.protein * 4 + userMacros.carbs * 4 + userMacros.fat * 9;
                const proteinPercent = ((userMacros.protein * 4) / totalMacros * 100).toFixed(0);
                const carbsPercent = ((userMacros.carbs * 4) / totalMacros * 100).toFixed(0);
                const fatPercent = ((userMacros.fat * 9) / totalMacros * 100).toFixed(0);

                document.getElementById('macro-protein-value').textContent = userMacros.protein;
                document.getElementById('macro-carbs-value').textContent = userMacros.carbs;
                document.getElementById('macro-fat-value').textContent = userMacros.fat;

                document.getElementById('protein-percent').textContent = proteinPercent;
                document.getElementById('carbs-percent').textContent = carbsPercent;
                document.getElementById('fat-percent').textContent = fatPercent;

                document.querySelector('.progress-protein').style.width = proteinPercent + '%';
                document.querySelector('.progress-carbs').style.width = carbsPercent + '%';
                document.querySelector('.progress-fat').style.width = fatPercent + '%';

                // Atualizar gr√°fico de pizza (CSS conic-gradient)
                const pieChart = document.getElementById('macro-pie');
                pieChart.style.setProperty('--protein-percent', proteinPercent);
                pieChart.style.setProperty('--carbs-percent', carbsPercent);
            }
        }

        // === TABELA DE ALIMENTOS ===
        function renderFoodsTable() {
            const tbody = document.getElementById('foods-tbody');
            tbody.innerHTML = '';

            let filteredFoods = foodsDatabase;

            // Filtro por categoria
            if (currentCategory) {
                filteredFoods = filteredFoods.filter(f => f.categoria === currentCategory);
            }

            // Busca
            const searchTerm = document.getElementById('food-search')?.value.toLowerCase() || '';
            if (searchTerm) {
                filteredFoods = filteredFoods.filter(f =>
                    f.nome.toLowerCase().includes(searchTerm) ||
                    f.categoria.toLowerCase().includes(searchTerm)
                );
            }

            // Ordena√ß√£o
            filteredFoods.sort((a, b) => {
                const aVal = a[currentSortField];
                const bVal = b[currentSortField];

                if (typeof aVal === 'string') {
                    return currentSortOrder === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }

                return currentSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
            });

            filteredFoods.forEach(food => {
                const isFavorite = favorites.includes(food.id);
                const row = `
                    <tr>
                        <td>
                            <strong>${food.nome}</strong><br>
                            <span class="badge badge-${food.categoria}">${food.categoria}</span>
                        </td>
                        <td><strong style="color: var(--primary);">${food.proteina}g</strong></td>
                        <td>${food.carbs}g</td>
                        <td>${food.gordura}g</td>
                        <td><strong>${food.calorias}</strong></td>
                        <td style="color: var(--accent);">R$ ${food.custo.toFixed(2)}</td>
                        <td>
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${food.id})">
                                ${isFavorite ? '‚≠ê' : '‚òÜ'}
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (filteredFoods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-sec);">Nenhum alimento encontrado</td></tr>';
            }
        }

        function sortTable(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            renderFoodsTable();
        }

        function filterFoods() {
            renderFoodsTable();
        }

        function filterByCategory(category) {
            currentCategory = category;
            renderFoodsTable();
        }

        // === FAVORITOS ===
        function toggleFavorite(foodId) {
            const index = favorites.indexOf(foodId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(foodId);
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderFoodsTable();
            renderFavorites();
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-list');

            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚≠ê</div>
                        <p>Nenhum alimento favoritado ainda.</p>
                        <p style="font-size: 13px; margin-top: 8px;">V√° para a aba Alimentos e marque seus favoritos!</p>
                    </div>
                `;
                return;
            }

            const favFoods = foodsDatabase.filter(f => favorites.includes(f.id));

            container.innerHTML = favFoods.map(food => `
                <div class="history-item">
                    <div>
                        <strong>${food.nome}</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--text-sec);">
                            ${food.proteina}g prot | ${food.carbs}g carb | ${food.gordura}g gord | ${food.calorias} kcal
                        </div>
                    </div>
                    <button class="btn btn-outline" style="padding: 8px 16px;" onclick="toggleFavorite(${food.id})">
                        ‚ùå Remover
                    </button>
                </div>
            `).join('');
        }

        // === COMPARADOR ===
        function populateCompareSelects() {
            const selects = ['compare-food-1', 'compare-food-2', 'compare-food-3'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione...</option>';
                    foodsDatabase.forEach(food => {
                        select.innerHTML += `<option value="${food.id}">${food.nome}</option>`;
                    });
                }
            });
        }

        function compareFoods() {
            const food1Id = parseInt(document.getElementById('compare-food-1').value);
            const food2Id = parseInt(document.getElementById('compare-food-2').value);
            const food3Id = parseInt(document.getElementById('compare-food-3').value);

            const selectedFoods = [food1Id, food2Id, food3Id]
                .filter(id => id)
                .map(id => foodsDatabase.find(f => f.id === id));

            if (selectedFoods.length < 2) {
                alert('Selecione pelo menos 2 alimentos para comparar!');
                return;
            }

            const container = document.getElementById('compare-results');

            // Determinar vencedores
            const bestProtein = selectedFoods.reduce((max, f) => f.proteina > max.proteina ? f : max);
            const bestCalories = selectedFoods.reduce((min, f) => f.calorias < min.calorias ? f : min);
            const bestCost = selectedFoods.reduce((min, f) => (f.custo/f.proteina) < (min.custo/min.proteina) ? f : min);

            container.innerHTML = `
                <h3 style="margin-bottom: 16px; color: var(--primary);">üìä Resultados da Compara√ß√£o</h3>
                <div class="compare-grid">
                    ${selectedFoods.map(food => {
                        const isWinnerProtein = food.id === bestProtein.id;
                        const isWinnerCalories = food.id === bestCalories.id;
                        const isWinnerCost = food.id === bestCost.id;
                        const isOverallWinner = isWinnerProtein && isWinnerCost;

                        return `
                            <div class="compare-card ${isOverallWinner ? 'winner' : ''}">
                                ${isOverallWinner ? '<div style="text-align: center; margin-bottom: 8px; font-size: 24px;">üèÜ</div>' : ''}
                                <h4 style="margin-bottom: 16px; text-align: center;">${food.nome}</h4>
                                <div style="background: var(--surface-2); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span ${isWinnerProtein ? 'style="color: var(--success); font-weight: 700;"' : ''}>Prote√≠na:</span>
                                        <strong>${food.proteina}g ${isWinnerProtein ? 'üëë' : ''}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Carboidratos:</span>
                                        <strong>${food.carbs}g</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Gorduras:</span>
                                        <strong>${food.gordura}g</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span ${isWinnerCalories ? 'style="color: var(--success); font-weight: 700;"' : ''}>Calorias:</span>
                                        <strong>${food.calorias} ${isWinnerCalories ? 'üëë' : ''}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span ${isWinnerCost ? 'style="color: var(--success); font-weight: 700;"' : ''}>Custo/g prot:</span>
                                        <strong>R$ ${(food.custo/food.proteina).toFixed(3)} ${isWinnerCost ? 'üëë' : ''}</strong>
                                    </div>
                                </div>
                                <div style="text-align: center; color: var(--text-sec); font-size: 12px;">
                                    Por√ß√£o: ${food.porcao}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 20px; padding: 16px; background: var(--surface-2); border-radius: 12px;">
                    <h4 style="margin-bottom: 12px;">üìù An√°lise:</h4>
                    <ul style="margin-left: 20px; color: var(--text-sec);">
                        <li><strong>${bestProtein.nome}</strong> tem a maior quantidade de prote√≠na (${bestProtein.proteina}g)</li>
                        <li><strong>${bestCalories.nome}</strong> tem menos calorias (${bestCalories.calorias} kcal)</li>
                        <li><strong>${bestCost.nome}</strong> tem o melhor custo-benef√≠cio (R$ ${(bestCost.custo/bestCost.proteina).toFixed(3)}/g)</li>
                    </ul>
                </div>
            `;
        }

        // === RECEITAS ===
        function renderRecipes() {
            const container = document.getElementById('recipes-list');

            container.innerHTML = recipesDatabase.map(recipe => `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <div class="recipe-title">${recipe.nome}</div>
                        <div style="font-size: 13px; opacity: 0.9;">‚è±Ô∏è ${recipe.tempo}</div>
                    </div>
                    <div class="recipe-body">
                        <div class="recipe-macros">
                            <div class="recipe-macro">
                                <div style="font-size: 12px; color: var(--text-sec); margin-bottom: 4px;">Prote√≠na</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${recipe.proteina}g</div>
                            </div>
                            <div class="recipe-macro">
                                <div style="font-size: 12px; color: var(--text-sec); margin-bottom: 4px;">Carbs</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${recipe.carbs}g</div>
                            </div>
                            <div class="recipe-macro">
                                <div style="font-size: 12px; color: var(--text-sec); margin-bottom: 4px;">Gordura</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--danger);">${recipe.gordura}g</div>
                            </div>
                            <div class="recipe-macro">
                                <div style="font-size: 12px; color: var(--text-sec); margin-bottom: 4px;">Calorias</div>
                                <div style="font-size: 20px; font-weight: 700;">${recipe.calorias}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px;">üõí Ingredientes:</h4>
                            <ul style="margin-left: 20px; color: var(--text-sec);">
                                ${recipe.ingredientes.map(ing => `<li>${ing}</li>`).join('')}
                            </ul>
                        </div>

                        <div>
                            <h4 style="margin-bottom: 8px;">üë®‚Äçüç≥ Modo de Preparo:</h4>
                            <p style="color: var(--text-sec); line-height: 1.6;">${recipe.preparo}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // === PLANEJADOR DE REFEI√á√ïES INTELIGENTE ===
        function initMealPlanner() {
            const meals = [
                { key: 'cafe', label: '‚òï Caf√© da Manh√£', weight: 0.20 },
                { key: 'lancheManha', label: 'üçé Lanche da Manh√£', weight: 0.10 },
                { key: 'almoco', label: 'üçΩÔ∏è Almo√ßo', weight: 0.30 },
                { key: 'lancheTarde', label: 'ü•™ Lanche da Tarde', weight: 0.10 },
                { key: 'jantar', label: 'üç≤ Jantar', weight: 0.25 },
                { key: 'ceia', label: 'üåô Ceia', weight: 0.05 }
            ];

            const container = document.getElementById('meal-planner-container');

            // Filtrar apenas fontes proteicas principais
            const proteinOptions = foodsDatabase
                .filter(f => f.proteina >= 8) // Apenas alimentos com boa quantidade de prote√≠na
                .map(f => `<option value="${f.id}">${f.nome} (${f.proteina}g prote√≠na/${f.porcao})</option>`)
                .join('');

            container.innerHTML = meals.map(meal => `
                <div class="card" style="margin-bottom: 16px; background: var(--gradient-surface);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;">${meal.label}</h4>
                        <span style="font-size: 12px; color: var(--text-sec); background: var(--surface-2); padding: 4px 12px; border-radius: 12px;">
                            ${(meal.weight * 100).toFixed(0)}% prote√≠na di√°ria
                        </span>
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label class="form-label" style="font-size: 13px;">ü•© Prote√≠na principal:</label>
                        <select class="form-select protein-select" data-meal="${meal.key}" data-index="0">
                            <option value="">-- Selecione --</option>
                            ${proteinOptions}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 13px;">ü•© Prote√≠na secund√°ria (opcional):</label>
                        <select class="form-select protein-select" data-meal="${meal.key}" data-index="1">
                            <option value="">-- Selecione --</option>
                            ${proteinOptions}
                        </select>
                    </div>
                    <div id="suggestions-${meal.key}" style="margin-top: 12px; display: none;"></div>
                </div>
            `).join('');

            // Adicionar event listeners para mostrar sugest√µes ao selecionar prote√≠na
            document.querySelectorAll('.protein-select').forEach(select => {
                select.addEventListener('change', function() {
                    const mealKey = this.dataset.meal;
                    const suggestionsDiv = document.getElementById(`suggestions-${mealKey}`);

                    if (this.value) {
                        suggestionsDiv.style.display = 'block';
                        suggestionsDiv.innerHTML = `
                            <div style="background: var(--highlight); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                                <p style="font-size: 12px; color: var(--text-sec); margin: 0;">
                                    <strong style="color: var(--primary);">‚ú® Sugest√µes autom√°ticas</strong> de carboidratos e gorduras ser√£o geradas ao calcular o plano!
                                </p>
                            </div>
                        `;
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            });
        }

        // === FUN√á√ÉO AUXILIAR: FORMATAR QUANTIDADE COM UNIDADE CORRETA ===
        function formatQuantity(foodName, grams) {
            const unitConfig = foodUnits[foodName];

            if (!unitConfig) {
                // Alimento sem configura√ß√£o espec√≠fica - retorna em gramas
                return `${grams.toFixed(0)}g`;
            }

            const units = grams / unitConfig.gramsPerUnit;
            const limitedUnits = Math.min(units, unitConfig.maxUnits);
            const finalGrams = limitedUnits * unitConfig.gramsPerUnit;

            if (unitConfig.unit === 'scoop') {
                return `${Math.round(limitedUnits)} ${limitedUnits === 1 ? 'scoop' : 'scoops'} (${finalGrams.toFixed(0)}g)`;
            } else if (unitConfig.unit === 'unidade') {
                return `${Math.round(limitedUnits)} ${unitConfig.displayName}${limitedUnits > 1 ? 's' : ''}`;
            } else if (unitConfig.unit === 'colher') {
                const rounded = Math.round(limitedUnits * 2) / 2; // Arredondar para 0.5
                return `${rounded} ${unitConfig.displayName}${rounded > 1 ? 's' : ''} (${finalGrams.toFixed(0)}g)`;
            } else {
                return `${finalGrams.toFixed(0)}g`;
            }
        }

        // === FUN√á√ÉO AUXILIAR: CALCULAR GRAMAS REAIS CONSIDERANDO LIMITES ===
        function calculateRealGrams(foodName, targetGrams) {
            const unitConfig = foodUnits[foodName];

            if (!unitConfig) {
                return targetGrams; // Sem limite
            }

            const units = targetGrams / unitConfig.gramsPerUnit;
            const limitedUnits = Math.min(units, unitConfig.maxUnits);
            return limitedUnits * unitConfig.gramsPerUnit;
        }

        function calculateMealPlan() {
            if (!userMacros) {
                alert('Por favor, calcule seus macros primeiro na aba Calculadora!');
                switchTab('calculator');
                return;
            }

            const meals = [
                { key: 'cafe', label: '‚òï Caf√© da Manh√£', weight: 0.20 },
                { key: 'lanche1', label: 'üçé Lanche da Manh√£', weight: 0.10 },
                { key: 'almoco', label: 'üçΩÔ∏è Almo√ßo', weight: 0.30 },
                { key: 'lanche2', label: 'ü•™ Lanche da Tarde', weight: 0.10 },
                { key: 'jantar', label: 'üç≤ Jantar', weight: 0.25 },
                { key: 'ceia', label: 'üåô Ceia', weight: 0.05 }
            ];

            const selects = document.querySelectorAll('.meal-food-select');
            const mealPlan = {};

            selects.forEach(select => {
                const mealKey = select.dataset.meal;
                const foodId = parseInt(select.value);

                if (foodId) {
                    if (!mealPlan[mealKey]) {
                        mealPlan[mealKey] = [];
                    }
                    mealPlan[mealKey].push(foodId);
                }
            });

            if (Object.keys(mealPlan).length === 0) {
                alert('Selecione pelo menos um alimento em alguma refei√ß√£o!');
                return;
            }

            let planHTML = '<div class="card" style="background: var(--highlight);"><h3 style="margin-bottom: 20px; color: var(--primary);">üìã Seu Plano Alimentar</h3>';

            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            let totalCalories = 0;
            let totalCost = 0;

            meals.forEach(meal => {
                const foodIds = mealPlan[meal.key];
                if (foodIds && foodIds.length > 0) {
                    const proteinTarget = userMacros.protein * meal.weight;
                    const proteinPerFood = proteinTarget / foodIds.length;

                    planHTML += `<div style="margin-bottom: 24px; padding: 16px; background: var(--surface); border-radius: 12px;">`;
                    planHTML += `<h4 style="margin-bottom: 12px; color: var(--primary);">${meal.label}</h4>`;
                    planHTML += `<div style="font-size: 13px; color: var(--text-sec); margin-bottom: 12px;">Meta: ${proteinTarget.toFixed(0)}g de prote√≠na</div>`;

                    foodIds.forEach(foodId => {
                        const food = foodsDatabase.find(f => f.id === foodId);
                        const gramsNeeded = (proteinPerFood / food.proteina) * 100;
                        const actualProtein = (gramsNeeded / 100) * food.proteina;
                        const actualCarbs = (gramsNeeded / 100) * food.carbs;
                        const actualFat = (gramsNeeded / 100) * food.gordura;
                        const actualCalories = (gramsNeeded / 100) * food.calorias;
                        const actualCost = (gramsNeeded / 100) * food.custo;

                        totalProtein += actualProtein;
                        totalCarbs += actualCarbs;
                        totalFat += actualFat;
                        totalCalories += actualCalories;
                        totalCost += actualCost;

                        planHTML += `
                            <div style="padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong>${food.nome}</strong>
                                    <strong>${gramsNeeded.toFixed(0)}g</strong>
                                </div>
                                <div style="font-size: 12px; color: var(--text-sec);">
                                    ${actualProtein.toFixed(1)}g prot | ${actualCarbs.toFixed(1)}g carb | ${actualFat.toFixed(1)}g gord | ${actualCalories.toFixed(0)} kcal
                                </div>
                            </div>
                        `;
                    });

                    planHTML += `</div>`;
                }
            });

            planHTML += `
                <div style="margin-top: 24px; padding: 20px; background: var(--surface); border-radius: 12px; border: 2px solid var(--primary);">
                    <h4 style="margin-bottom: 16px;">üìä Totais do Dia</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--primary);">${totalProtein.toFixed(0)}g</div>
                            <div style="font-size: 12px; color: var(--text-sec);">Prote√≠na</div>
                            <div style="font-size: 11px; color: var(--text-sec);">Meta: ${userMacros.protein}g</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent);">${totalCarbs.toFixed(0)}g</div>
                            <div style="font-size: 12px; color: var(--text-sec);">Carboidratos</div>
                            <div style="font-size: 11px; color: var(--text-sec);">Meta: ${userMacros.carbs}g</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--danger);">${totalFat.toFixed(0)}g</div>
                            <div style="font-size: 12px; color: var(--text-sec);">Gorduras</div>
                            <div style="font-size: 11px; color: var(--text-sec);">Meta: ${userMacros.fat}g</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 800;">${totalCalories.toFixed(0)}</div>
                            <div style="font-size: 12px; color: var(--text-sec);">Calorias</div>
                            <div style="font-size: 11px; color: var(--text-sec);">Meta: ${userMacros.calories}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--success);">R$ ${totalCost.toFixed(2)}</div>
                            <div style="font-size: 12px; color: var(--text-sec);">Custo Total</div>
                            <div style="font-size: 11px; color: var(--text-sec);">Por dia</div>
                        </div>
                    </div>
                </div>
            `;

            planHTML += `
                <button class="btn btn-secondary btn-full" style="margin-top: 16px;" onclick="savePlanToHistory()">
                    üíæ Salvar Plano no Hist√≥rico
                </button>
            `;

            planHTML += '</div>';

            document.getElementById('plan-results').innerHTML = planHTML;
            document.getElementById('plan-results').style.display = 'block';
            document.getElementById('plan-results').scrollIntoView({ behavior: 'smooth' });

            // Armazenar plano atual para salvar
            window.currentPlan = {
                date: new Date().toISOString(),
                protein: totalProtein.toFixed(0),
                carbs: totalCarbs.toFixed(0),
                fat: totalFat.toFixed(0),
                calories: totalCalories.toFixed(0),
                cost: totalCost.toFixed(2),
                meals: mealPlan
            };
        }

        // === PLANEJADOR INTELIGENTE COM SUGEST√ïES AUTOM√ÅTICAS ===
        function calculateSmartMealPlan() {
            if (!userMacros) {
                alert('Por favor, calcule seus macros primeiro na aba Calculadora!');
                document.querySelectorAll('.nav-tab')[1].click(); // Ir para calculadora
                return;
            }

            const meals = [
                { key: 'cafe', label: '‚òï Caf√© da Manh√£', weight: 0.20 },
                { key: 'lancheManha', label: 'üçé Lanche da Manh√£', weight: 0.10 },
                { key: 'almoco', label: 'üçΩÔ∏è Almo√ßo', weight: 0.30 },
                { key: 'lancheTarde', label: 'ü•™ Lanche da Tarde', weight: 0.10 },
                { key: 'jantar', label: 'üç≤ Jantar', weight: 0.25 },
                { key: 'ceia', label: 'üåô Ceia', weight: 0.05 }
            ];

            // Coletar prote√≠nas selecionadas (at√© 2 por refei√ß√£o)
            const selectedProteins = {};
            document.querySelectorAll('.protein-select').forEach(select => {
                if (select.value) {
                    const meal = select.dataset.meal;
                    if (!selectedProteins[meal]) {
                        selectedProteins[meal] = [];
                    }
                    selectedProteins[meal].push(parseInt(select.value));
                }
            });

            if (Object.keys(selectedProteins).length === 0) {
                alert('Selecione pelo menos uma fonte proteica em alguma refei√ß√£o!');
                return;
            }

            let planHTML = '<div class="card" style="background: var(--highlight);"><h3 style="margin-bottom: 20px; color: var(--primary);">üçΩÔ∏è Seu Plano Inteligente</h3>';
            planHTML += '<p style="font-size: 13px; color: var(--text-sec); margin-bottom: 20px;">Plano gerado automaticamente com quantidades realistas e sugest√µes balanceadas</p>';

            let totalProtein = 0, totalCarbs = 0, totalFat = 0, totalCalories = 0, totalCost = 0;

            meals.forEach(meal => {
                const proteinIds = selectedProteins[meal.key];
                if (!proteinIds || proteinIds.length === 0) return; // Pular refei√ß√£o sem prote√≠na selecionada

                // Calcular metas da refei√ß√£o
                const mealProteinTarget = userMacros.protein * meal.weight;
                const mealCaloriesTarget = userMacros.calories * meal.weight;
                const mealCarbsTarget = userMacros.carbs * meal.weight;
                const mealFatTarget = userMacros.fat * meal.weight;

                // Dividir meta de prote√≠na igualmente entre as prote√≠nas selecionadas
                const proteinTargetPerSource = mealProteinTarget / proteinIds.length;

                // Processar cada prote√≠na selecionada
                const proteinItems = [];
                let totalActualProteinMacros = 0;
                let totalActualProteinCarbs = 0;
                let totalActualProteinFat = 0;
                let totalActualProteinCal = 0;
                let totalActualProteinCost = 0;

                proteinIds.forEach(proteinId => {
                    const protein = foodsDatabase.find(f => f.id === proteinId);
                    if (!protein) return;

                    // Calcular quantidade necess√°ria
                    let proteinGrams = (proteinTargetPerSource / protein.proteina) * 100;

                    // Aplicar limites realistas
                    const realProteinGrams = calculateRealGrams(protein.nome, proteinGrams);
                    const actualProteinMacros = (realProteinGrams / 100) * protein.proteina;
                    const actualProteinCarbs = (realProteinGrams / 100) * protein.carbs;
                    const actualProteinFat = (realProteinGrams / 100) * protein.gordura;
                    const actualProteinCal = (realProteinGrams / 100) * protein.calorias;
                    const actualProteinCost = (realProteinGrams / 100) * protein.custo;

                    totalActualProteinMacros += actualProteinMacros;
                    totalActualProteinCarbs += actualProteinCarbs;
                    totalActualProteinFat += actualProteinFat;
                    totalActualProteinCal += actualProteinCal;
                    totalActualProteinCost += actualProteinCost;

                    proteinItems.push({
                        protein,
                        realProteinGrams,
                        actualProteinMacros,
                        actualProteinCarbs,
                        actualProteinFat
                    });
                });

                // Calcular d√©ficit de macros (usando totais de todas as prote√≠nas)
                const remainingCarbs = Math.max(0, mealCarbsTarget - totalActualProteinCarbs);
                const remainingFat = Math.max(0, mealFatTarget - totalActualProteinFat);
                const remainingCalories = Math.max(0, mealCaloriesTarget - totalActualProteinCal);

                // Selecionar sugest√µes de carboidratos e gorduras
                const suggestions = mealSuggestions[meal.key] || mealSuggestions.almoco;
                const suggestedCarbName = suggestions.carbs[Math.floor(Math.random() * suggestions.carbs.length)];
                const suggestedFatName = suggestions.fats[Math.floor(Math.random() * suggestions.fats.length)];

                const suggestedCarb = carbsDatabase.find(c => c.nome === suggestedCarbName);
                const suggestedFat = fatsDatabase.find(f => f.nome === suggestedFatName);

                // Calcular quantidades de carbs e gorduras
                let carbGrams = 0, fatGrams = 0;
                let actualCarbMacros = 0, actualFatMacros = 0;
                let actualCarbCal = 0, actualFatCal = 0;

                if (suggestedCarb && remainingCarbs > 5) {
                    carbGrams = (remainingCarbs / suggestedCarb.carbs) * 100;
                    actualCarbMacros = (carbGrams / 100) * suggestedCarb.carbs;
                    actualCarbCal = (carbGrams / 100) * suggestedCarb.calorias;
                }

                if (suggestedFat && remainingFat > 2) {
                    fatGrams = (remainingFat / suggestedFat.gordura) * 100;
                    actualFatMacros = (fatGrams / 100) * suggestedFat.gordura;
                    actualFatCal = (fatGrams / 100) * suggestedFat.calorias;
                }

                // Totais da refei√ß√£o
                const mealTotalProt = totalActualProteinMacros + ((carbGrams /100) * (suggestedCarb?.proteina || 0)) + ((fatGrams / 100) * (suggestedFat?.proteina || 0));
                const mealTotalCarbs = totalActualProteinCarbs + actualCarbMacros + ((fatGrams / 100) * (suggestedFat?.carbs || 0));
                const mealTotalFat = totalActualProteinFat + ((carbGrams / 100) * (suggestedCarb?.gordura || 0)) + actualFatMacros;
                const mealTotalCal = totalActualProteinCal + actualCarbCal + actualFatCal;

                totalProtein += mealTotalProt;
                totalCarbs += mealTotalCarbs;
                totalFat += mealTotalFat;
                totalCalories += mealTotalCal;
                totalCost += totalActualProteinCost;

                // Renderizar refei√ß√£o
                planHTML += `
                    <div style="margin-bottom: 24px; padding: 16px; background: var(--surface); border-radius: 12px; border: 2px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: var(--primary);">${meal.label}</h4>
                            <span style="font-size: 11px; background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                                ${mealTotalCal.toFixed(0)} kcal
                            </span>
                        </div>
                `;

                // Renderizar todas as prote√≠nas selecionadas
                proteinItems.forEach(item => {
                    planHTML += `
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <strong style="color: var(--primary);">ü•© ${item.protein.nome}</strong>
                                <strong>${formatQuantity(item.protein.nome, item.realProteinGrams)}</strong>
                            </div>
                            <div style="font-size: 12px; color: var(--text-sec);">
                                ${item.actualProteinMacros.toFixed(1)}g prot | ${item.actualProteinCarbs.toFixed(1)}g carb | ${item.actualProteinFat.toFixed(1)}g gord
                            </div>
                        </div>
                    `;
                });

                if (suggestedCarb && carbGrams > 0) {
                    planHTML += `
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="color: var(--accent);">üçö ${suggestedCarb.nome}</span>
                                <span>${carbGrams.toFixed(0)}g</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-sec);">
                                ${actualCarbMacros.toFixed(1)}g carb | ${actualCarbCal.toFixed(0)} kcal
                            </div>
                        </div>
                    `;
                }

                if (suggestedFat && fatGrams > 0) {
                    planHTML += `
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--danger);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="color: var(--danger);">ü•ë ${suggestedFat.nome}</span>
                                <span>${fatGrams.toFixed(0)}g</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-sec);">
                                ${actualFatMacros.toFixed(1)}g gord | ${actualFatCal.toFixed(0)} kcal
                            </div>
                        </div>
                    `;
                }

                planHTML += `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-sec);">
                            <strong>Total da refei√ß√£o:</strong> ${mealTotalProt.toFixed(0)}g prot | ${mealTotalCarbs.toFixed(0)}g carb | ${mealTotalFat.toFixed(0)}g gord
                        </div>
                    </div>
                `;
            });

            // Resumo final
            const proteinPercentage = ((totalProtein / userMacros.protein) * 100).toFixed(0);
            const carbsPercentage = ((totalCarbs / userMacros.carbs) * 100).toFixed(0);
            const fatPercentage = ((totalFat / userMacros.fat) * 100).toFixed(0);

            planHTML += `
                <div style="margin-top: 24px; padding: 20px; background: var(--gradient-primary); border-radius: 12px; color: white;">
                    <h4 style="margin-bottom: 16px; color: white;">üìä Resumo do Dia</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 800;">${totalProtein.toFixed(0)}g</div>
                            <div style="font-size: 12px; opacity: 0.9;">Prote√≠nas</div>
                            <div style="font-size: 11px; opacity: 0.8;">${proteinPercentage}% da meta</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 800;">${totalCarbs.toFixed(0)}g</div>
                            <div style="font-size: 12px; opacity: 0.9;">Carboidratos</div>
                            <div style="font-size: 11px; opacity: 0.8;">${carbsPercentage}% da meta</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 800;">${totalFat.toFixed(0)}g</div>
                            <div style="font-size: 12px; opacity: 0.9;">Gorduras</div>
                            <div style="font-size: 11px; opacity: 0.8;">${fatPercentage}% da meta</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 800;">${totalCalories.toFixed(0)}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Calorias</div>
                            <div style="font-size: 11px; opacity: 0.8;">Meta: ${userMacros.calories}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 800;">R$ ${totalCost.toFixed(2)}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Custo</div>
                            <div style="font-size: 11px; opacity: 0.8;">Por dia</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary btn-full" style="margin-top: 16px;" onclick="savePlanToHistory()">
                    üíæ Salvar Plano no Hist√≥rico
                </button>
            </div>`;

            document.getElementById('plan-results').innerHTML = planHTML;
            document.getElementById('plan-results').style.display = 'block';
            document.getElementById('plan-results').scrollIntoView({ behavior: 'smooth' });

            // Armazenar plano atual
            window.currentPlan = {
                date: new Date().toISOString(),
                protein: totalProtein.toFixed(0),
                carbs: totalCarbs.toFixed(0),
                fat: totalFat.toFixed(0),
                calories: totalCalories.toFixed(0),
                cost: totalCost.toFixed(2),
                meals: selectedProteins
            };
        }

        function savePlanToHistory() {
            if (!window.currentPlan) return;

            history.unshift(window.currentPlan);
            if (history.length > 30) history = history.slice(0, 30); // Manter apenas √∫ltimos 30

            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();

            alert('‚úÖ Plano salvo no hist√≥rico com sucesso!');
        }

        // === HIST√ìRICO ===
        function renderHistory() {
            const container = document.getElementById('history-list');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>Nenhum plano salvo ainda.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Crie um plano na aba Planejador e salve-o!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map((plan, index) => {
                const date = new Date(plan.date);
                const dateStr = date.toLocaleDateString('pt-BR');
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="history-item">
                        <div style="flex: 1; cursor: pointer;" onclick="viewHistoryDetails(${index})">
                            <div style="font-weight: 600; margin-bottom: 4px;">üìÖ ${dateStr} √†s ${timeStr}</div>
                            <div style="font-size: 13px; color: var(--text-sec);">
                                ${plan.protein}g prot | ${plan.carbs}g carb | ${plan.fat}g gord | ${plan.calories} kcal | R$ ${plan.cost}
                            </div>
                            <div style="font-size: 11px; color: var(--primary); margin-top: 4px;">
                                üëÅÔ∏è Clique para ver detalhes
                            </div>
                        </div>
                        <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="event.stopPropagation(); deleteHistoryItem(${index})">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        function deleteHistoryItem(index) {
            if (confirm('Deseja realmente remover este plano do hist√≥rico?')) {
                history.splice(index, 1);
                localStorage.setItem('history', JSON.stringify(history));
                renderHistory();
            }
        }

        function clearHistory() {
            if (confirm('Deseja realmente limpar todo o hist√≥rico?')) {
                history = [];
                localStorage.setItem('history', JSON.stringify(history));
                renderHistory();
            }
        }

        function viewHistoryDetails(index) {
            const plan = history[index];
            if (!plan) return;

            const date = new Date(plan.date);
            const dateStr = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            const container = document.getElementById('history-details');

            let detailsHTML = `
                <div class="card" style="background: var(--highlight); border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin-bottom: 8px; color: var(--primary);">üìã Detalhes do Plano</h3>
                            <div style="font-size: 13px; color: var(--text-sec); text-transform: capitalize;">
                                ${dateStr} √†s ${timeStr}
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="closeHistoryDetails()" style="padding: 8px 16px;">‚úï Fechar</button>
                    </div>

                    <!-- Resumo dos Macros -->
                    <div style="background: var(--gradient-primary); padding: 16px; border-radius: 12px; margin-bottom: 20px; color: white;">
                        <h4 style="margin-bottom: 12px; color: white;">üìä Resumo Nutricional</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;">${plan.protein}g</div>
                                <div style="font-size: 11px; opacity: 0.9;">Prote√≠nas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;">${plan.carbs}g</div>
                                <div style="font-size: 11px; opacity: 0.9;">Carboidratos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;">${plan.fat}g</div>
                                <div style="font-size: 11px; opacity: 0.9;">Gorduras</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;">${plan.calories}</div>
                                <div style="font-size: 11px; opacity: 0.9;">Calorias</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;">R$ ${plan.cost}</div>
                                <div style="font-size: 11px; opacity: 0.9;">Custo/dia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Refei√ß√µes do Plano -->
                    <h4 style="margin-bottom: 12px; color: var(--primary);">üçΩÔ∏è Refei√ß√µes Planejadas</h4>
            `;

            // Mapear labels das refei√ß√µes
            const mealLabels = {
                'cafe': '‚òï Caf√© da Manh√£',
                'lancheManha': 'üçé Lanche da Manh√£',
                'almoco': 'üçΩÔ∏è Almo√ßo',
                'lancheTarde': 'ü•™ Lanche da Tarde',
                'jantar': 'üç≤ Jantar',
                'ceia': 'üåô Ceia'
            };

            // Renderizar cada refei√ß√£o
            if (plan.meals) {
                Object.entries(plan.meals).forEach(([mealKey, proteinIds]) => {
                    const mealLabel = mealLabels[mealKey] || mealKey;

                    detailsHTML += `
                        <div style="background: var(--surface); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--primary);">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--primary);">${mealLabel}</div>
                    `;

                    // Se proteinIds √© um array (nova vers√£o)
                    if (Array.isArray(proteinIds)) {
                        proteinIds.forEach(proteinId => {
                            const protein = foodsDatabase.find(f => f.id === proteinId);
                            if (protein) {
                                detailsHTML += `
                                    <div style="font-size: 13px; color: var(--text); margin-left: 12px; margin-bottom: 4px;">
                                        ü•© ${protein.nome}
                                    </div>
                                `;
                            }
                        });
                    } else {
                        // Compatibilidade com vers√£o antiga (proteinId √∫nico)
                        const protein = foodsDatabase.find(f => f.id === proteinIds);
                        if (protein) {
                            detailsHTML += `
                                <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
                                    ü•© ${protein.nome}
                                </div>
                            `;
                        }
                    }

                    detailsHTML += `</div>`;
                });
            }

            // Bot√£o de compartilhar no WhatsApp
            detailsHTML += `
                    <button class="btn btn-primary btn-full" onclick="shareHistoryToWhatsApp(${index})" style="margin-top: 16px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                        Compartilhar no WhatsApp
                    </button>
                </div>
            `;

            container.innerHTML = detailsHTML;
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function closeHistoryDetails() {
            document.getElementById('history-details').style.display = 'none';
        }

        function shareHistoryToWhatsApp(index) {
            const plan = history[index];
            if (!plan) return;

            const date = new Date(plan.date);
            const dateStr = date.toLocaleDateString('pt-BR');

            let message = `*üéØ MEU PLANO ALIMENTAR* \\n`;
            message += `üìÖ Data: ${dateStr}\\n\\n`;
            message += `*üìä RESUMO NUTRICIONAL*\\n`;
            message += `ü•© Prote√≠nas: ${plan.protein}g\\n`;
            message += `üçö Carboidratos: ${plan.carbs}g\\n`;
            message += `ü•ë Gorduras: ${plan.fat}g\\n`;
            message += `üî• Calorias: ${plan.calories} kcal\\n`;
            message += `üí∞ Custo/dia: R$ ${plan.cost}\\n\\n`;
            message += `*üçΩÔ∏è REFEI√á√ïES*\\n`;

            const mealLabels = {
                'cafe': '\\u2615 Caf√© da Manh√£',
                'lancheManha': '\\uD83C\\uDF4E Lanche da Manh√£',
                'almoco': '\\uD83C\\uDF7D\\uFE0F Almo√ßo',
                'lancheTarde': '\\uD83E\\uDD6A Lanche da Tarde',
                'jantar': '\\uD83C\\uDF72 Jantar',
                'ceia': '\\uD83C\\uDF19 Ceia'
            };

            if (plan.meals) {
                Object.entries(plan.meals).forEach(([mealKey, proteinIds]) => {
                    const mealLabel = mealLabels[mealKey] || mealKey;
                    message += `\\n${mealLabel}:\\n`;

                    if (Array.isArray(proteinIds)) {
                        proteinIds.forEach(proteinId => {
                            const protein = foodsDatabase.find(f => f.id === proteinId);
                            if (protein) {
                                message += `  ‚Ä¢ ${protein.nome}\\n`;
                            }
                        });
                    } else {
                        const protein = foodsDatabase.find(f => f.id === proteinIds);
                        if (protein) {
                            message += `  ‚Ä¢ ${protein.nome}\\n`;
                        }
                    }
                });
            }

            message += `\\n---\\n`;
            message += `\\uD83D\\uDCAA Gerado pelo Prote√≠naMax\\n`;
            message += window.location.href;

            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
    </script>
</body>
</html>
